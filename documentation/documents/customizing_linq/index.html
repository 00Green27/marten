<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8"> 
        <meta charset="utf-8">
        <meta name="generator" content="Bootply" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<title>Marten - Extending Marten's Linq Support</title>
		<link href="/marten/content/bootstrap.min.css" rel="stylesheet" type="text/css" />
		<link href="/marten/content/prism.css" rel="stylesheet" type="text/css" />
		<link href="/marten/content/theme.css" rel="stylesheet" type="text/css" />
		<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" />
        

        <link rel="apple-touch-icon" href="/bootstrap/img/apple-touch-icon.png">
        <link rel="apple-touch-icon" sizes="72x72" href="/bootstrap/img/apple-touch-icon-72x72.png">
        <link rel="apple-touch-icon" sizes="114x114" href="/bootstrap/img/apple-touch-icon-114x114.png">


        <!-- CSS code from Bootply.com editor -->
        <link href="/marten/content/affix.css" rel="stylesheet" type="text/css" />
    </head>
    
    <!-- HTML code from Bootply.com editor -->
    
    <body  >

<a href="https://github.com/jasperfx/marten"><img style="z-index: 5000; position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/e7bbb0521b397edbd5fe43e7f760759336b5e05f/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677265656e5f3030373230302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"></a>
        
        <nav class="navbar navbar-default navbar-fixed-top" role="banner">
		  <div class="container">
		    <div class="navbar-header">
		      <a href="/marten" class="navbar-brand">Marten</a>
		    </div>
		    <nav class="collapse navbar-collapse" role="navigation">
		      <ul class="nav navbar-nav pull-right">
            <li>
              <a href="/marten/getting_started">Getting Started</a>
            </li>
		        <li>
		          <a href="/marten/documentation">Documentation</a>
		        </li>
		        <li>
<a href="https://gitter.im/jasperfx/marten?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge&amp;utm_content=badge"><img src="https://camo.githubusercontent.com/da2edb525cde1455a622c58c0effc3a90b9a181c/68747470733a2f2f6261646765732e6769747465722e696d2f4a6f696e253230436861742e737667" alt="Join the chat at https://gitter.im/jasperfx/marten" data-canonical-src="https://badges.gitter.im/Join%20Chat.svg" style="max-width:100%;"></a>
		        </li>
		      	<li><a href="/marten/documentation/documents/linq" title="Querying Documents with Linq">Previous</a></li>
		      	<li><a href="/marten/documentation/documents/sql" title="Querying Documents with Postgresql SQL">Next</a></li>
		      </ul>
      <div class="navbar-form navbar-left" role="search">
        <div class="form-group">
          <input id="search" type="search" class="form-control" placeholder="Search">
        </div>
      </div>

		    </nav>

		  </div>
		</nav>

		  <div class="container">
		  	<nav class="navbar-inverse">
		  		<ol class="breadcrumb"><li><a href="/marten/">Marten</a></li><li><a href="/marten/documentation">Documentation</a></li><li><a href="/marten/documentation/documents">Marten as Document Db</a></li><li class="active">Extending Marten&#39;s Linq Support</li></ol>
		  	</nav>
		  </div>

		<!--main-->
		<div class="container">
			<div class="row">
		      <!--left-->
		      
		      <div class="col-md-3" id="leftCol">
		      	<h3>Marten 0.9.0</h3>
		      	<br />

				<ul class="nav nav-stacked affix" id="sidebar">

		        </ul>

		        	<h3 class="no-margin">Next</h3><p><a href="/marten/documentation/documents/sql">Querying Documents with Postgresql SQL</a></p>
		        	<h3 class="no-margin">Previous</h3><a href="/marten/documentation/documents/linq">Querying Documents with Linq</a></p>

		        </ul>
		      </div><!--/left-->
		      
		      <!--right-->
		      <div class="col-md-9">
			      	<h1>Extending Marten's Linq Support <a href="https://github.com/jasperfx/marten/blob/master/documentation/documentation/documents/customizing_linq.md"  class="text-muted small pull-right fa fa-github" style="margin-top: 10px"> Edit on GitHub</a></h1>
			      
			      	<hr />

			      	<div id="main-pane">
			      		<!--Title:Extending Marten's Linq Support-->
<p>**The Linq parsing and translation to Postgresql JSONB queries, not to mention Marten's own helpers and model, are not going
to be easily approachable for many people and this guide isn't exhaustive. Please feel free to ask for help in Marten's
Gitter room linked above.&quot;&quot;</p>
<p>New for v0.8, Marten allows you to add Linq parsing and querying support for your own custom methods.
Using the (admittedly contrived) example from Marten's tests, say that you want to reuse a small part of a <code>Where()</code> clause across
different queries for &quot;IsBlue().&quot; First, write the method you want to be recognized by Marten's Linq support:</p>
 <pre><code class="language-csharp">
    public class IsBlue : IMethodCallParser
    {
        private static readonly PropertyInfo _property = ReflectionHelper.GetProperty&lt;ColorTarget&gt;(x =&gt; x.Color);

        public bool Matches(MethodCallExpression expression)
        {
            return expression.Method.Name == nameof(CustomExtensions.IsBlue);
        }

        public IWhereFragment Parse(IDocumentMapping mapping, ISerializer serializer, MethodCallExpression expression)
        {
            var locator = mapping.FieldFor(new MemberInfo[] {_property}).SqlLocator;

            return new WhereFragment($&quot;{locator} = &#39;Blue&#39;&quot;);
        }
    }
</code></pre>
<p>Note a couple things here:</p>
<ol>
<li>If you're only using the method for Linq queries, it technically doesn't have to be implemented and never actually runs</li>
<li>The methods do not have to be extension methods, but we're guessing that will be the most common usage of this</li>
</ol>
<p>Now, to create a custom Linq parser for the <code>IsBlue()</code> method, you need to create a custom implementation of the <code>IMethodCallParser</code>
interface shown below:</p>
 <pre><code class="language-csharp">
    /// &lt;summary&gt;
    /// Models the Sql generation for a method call
    /// in a Linq query. For example, map an expression like Where(x =&gt; x.Property.StartsWith(&quot;prefix&quot;))
    /// to part of a Sql WHERE clause
    /// &lt;/summary&gt;
    public interface IMethodCallParser
    {
        /// &lt;summary&gt;
        /// Can this parser create a Sql where clause
        /// from part of a Linq expression that calls
        /// a method
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;expression&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        bool Matches(MethodCallExpression expression);

        /// &lt;summary&gt;
        /// Creates an IWhereFragment object that Marten
        /// uses to help construct the underlying Sql
        /// command
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;mapping&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;serializer&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;expression&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        IWhereFragment Parse(
            IDocumentMapping mapping, 
            ISerializer serializer, 
            MethodCallExpression expression
            );
    }
</code></pre>
<p>The <code>IMethodCallParser</code> interface needs to match on method expressions that it could parse, and be able to turn the Linq expression into
part of a Postgresql &quot;where&quot; clause. The custom Linq parser for <code>IsBlue()</code> is shown below:</p>
<pre><code class="language-csharp">
        public static bool IsBlue(this ColorTarget target)
        {
            return target.Color == &quot;Blue&quot;;
        }
</code></pre>
<p>Lastly, to plug in our new parser, we can add that to the <code>StoreOptions</code> object that we use to bootstrap a new <code>DocumentStore</code> as shown below:</p>
<pre><code class="language-csharp">
        [Fact]
        public void query_with_custom_parser()
        {
            using (var store = DocumentStore.For(_ =&gt;
            {
                _.Connection(ConnectionSource.ConnectionString);

                // IsBlue is a custom parser I used for testing this
                _.Linq.MethodCallParsers.Add(new IsBlue());
                _.AutoCreateSchemaObjects = AutoCreate.All;
            }))
            {

                store.Advanced.Clean.CompletelyRemoveAll();


                var targets = new List&lt;ColorTarget&gt;();
                for (var i = 0; i &lt; 25; i++)
                {
                    targets.Add(new ColorTarget {Color = &quot;Blue&quot;});
                    targets.Add(new ColorTarget {Color = &quot;Green&quot;});
                    targets.Add(new ColorTarget {Color = &quot;Red&quot;});
                }

                var count = targets.Where(x =&gt; x.IsBlue()).Count();

                targets.Each(x =&gt; x.Id = Guid.NewGuid());

                store.BulkInsert(targets.ToArray());

                using (var session = store.QuerySession())
                {
                    session.Query&lt;ColorTarget&gt;().Where(x =&gt; x.IsBlue()).Count()
                        .ShouldBe(count);
                }
            }
        }
</code></pre>


			      	</div>

			      	<hr />

			      	<nav>
				        <span>
				        	<strong>Previous: </strong><a href="/marten/documentation/documents/linq">Querying Documents with Linq</a>

				        </span>
				        <span class="pull-right">

				        	<strong>Next: </strong><a href="/marten/documentation/documents/sql">Querying Documents with Postgresql SQL</a>

				        </span>
			      	</nav>

		      </div><!--/right-->
		  	</div><!--/row-->
		</div><!--/container-->


    </body>


    <foot>
        <script type='text/javascript' src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
        <script type='text/javascript' src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

        <script type="text/javascript" src="/marten/content/embed.js"></script>
        <script type="text/javascript" src="/marten/content/prism.js"></script>
        <script type="text/javascript" src="/marten/content/sidebar.js"></script>
        <script type="text/javascript" src="/marten/content/affix.js"></script>

<script>
$('#search').keyup(function(e){
  if(e.keyCode == 13) {
    var search = $('#search').val();

    var url = 'https://www.google.com/#q=site:jasperfx.github.io ' + search;
    url = encodeURI(url);

    //alert(url);

    window.location.href = url;

    e.stopPropagation();
    if (e.cancelBubble!=null) e.cancelBubble = true;
    return false;
  }



}); 

</script>
    </foot>
</html>

