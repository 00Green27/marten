<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8"> 
        <meta charset="utf-8">
        <meta name="generator" content="Bootply" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<title>Marten - Customizing Document Storage and Querying</title>
		<link href="/marten/content/bootstrap.min.css" rel="stylesheet" type="text/css" />
		<link href="/marten/content/prism.css" rel="stylesheet" type="text/css" />
		<link href="/marten/content/theme.css" rel="stylesheet" type="text/css" />
		<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" />
        

        <link rel="apple-touch-icon" href="/bootstrap/img/apple-touch-icon.png">
        <link rel="apple-touch-icon" sizes="72x72" href="/bootstrap/img/apple-touch-icon-72x72.png">
        <link rel="apple-touch-icon" sizes="114x114" href="/bootstrap/img/apple-touch-icon-114x114.png">


        <!-- CSS code from Bootply.com editor -->
        <link href="/marten/content/affix.css" rel="stylesheet" type="text/css" />
    </head>
    
    <!-- HTML code from Bootply.com editor -->
    
    <body  >

<a href="https://github.com/jasperfx/marten"><img style="z-index: 5000; position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/e7bbb0521b397edbd5fe43e7f760759336b5e05f/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677265656e5f3030373230302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"></a>
        
        <nav class="navbar navbar-default navbar-fixed-top" role="banner">
		  <div class="container">
		    <div class="navbar-header">
		      <a href="/marten" class="navbar-brand">Marten</a>
		    </div>
		    <nav class="collapse navbar-collapse" role="navigation">
		      <ul class="nav navbar-nav pull-right">
            <li>
              <a href="/marten/getting_started">Getting Started</a>
            </li>
		        <li>
		          <a href="/marten/documentation">Documentation</a>
		        </li>
		        <li>
<a href="https://gitter.im/jasperfx/marten?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge&amp;utm_content=badge"><img src="https://camo.githubusercontent.com/da2edb525cde1455a622c58c0effc3a90b9a181c/68747470733a2f2f6261646765732e6769747465722e696d2f4a6f696e253230436861742e737667" alt="Join the chat at https://gitter.im/jasperfx/marten" data-canonical-src="https://badges.gitter.im/Join%20Chat.svg" style="max-width:100%;"></a>
		        </li>
		      	<li><a href="/marten/documentation/documents/diagnostics" title="Diagnostics">Previous</a></li>
		      	<li><a href="/marten/documentation/documents/text_search" title="Full Text Searching">Next</a></li>
		      </ul>
      <div class="navbar-form navbar-left" role="search">
        <div class="form-group">
          <input id="search" type="search" class="form-control" placeholder="Search">
        </div>
      </div>

		    </nav>

		  </div>
		</nav>

		  <div class="container">
		  	<nav class="navbar-inverse">
		  		<ol class="breadcrumb"><li><a href="/marten/">Marten</a></li><li><a href="/marten/documentation">Documentation</a></li><li><a href="/marten/documentation/documents">Marten as Document Db</a></li><li class="active">Customizing Document Storage and Querying</li></ol>
		  	</nav>
		  </div>

		<!--main-->
		<div class="container">
			<div class="row">
		      <!--left-->
		      
		      <div class="col-md-3" id="leftCol">
		      	<h3>Marten 0.6.0</h3>
		      	<br />

				<ul class="nav nav-stacked affix" id="sidebar">

		        </ul>

		        	<h3 class="no-margin">Next</h3><p><a href="/marten/documentation/documents/text_search">Full Text Searching</a></p>
		        	<h3 class="no-margin">Previous</h3><a href="/marten/documentation/documents/diagnostics">Diagnostics</a></p>

		        </ul>
		      </div><!--/left-->
		      
		      <!--right-->
		      <div class="col-md-9">
			      	<h1>Customizing Document Storage and Querying <a href="https://github.com/jasperfx/marten/blob/master/documentation/documentation/documents/customizing.md"  class="text-muted small pull-right fa fa-github" style="margin-top: 10px"> Edit on GitHub</a></h1>
			      
			      	<hr />

			      	<div id="main-pane">
			      		<!--Title:Customizing Document Storage and Querying-->
<!--Url:customizing-->
<p>While you can certainly write your own <a href="https://en.wikipedia.org/wiki/Data_definition_language">DDL</a>
and SQL queries for optimizing data fetching, Marten gives you a couple options for speeding up queries --
which all come at the cost of slower inserts because it's an imperfect world. Marten supports the ability to configure:</p>
<ul>
<li>Indexes on the JSONB data field itself</li>
<li>Opt into a more efficient &quot;upsert&quot; style for Postgresql 9.5</li>
<li>Duplicate properties into separate database fields with a matching index for optimized querying</li>
<li>Choose how Postgresql will search within JSONB documents</li>
</ul>
<p>At some point in the future Marten may support document hierarchies and more table customizations (foreign keys? table names?).</p>
<h2>MartenRegistry</h2>
<p>While there are some limited abilities to configure storage with attributes, the most complete option right now
is a fluent interface implemented by the <code>MartenRegistry</code>. To configure a Marten document store, first write
your own subclass of <code>MartenRegistry</code> and place declarations in the constructor function like this example:</p>
<pre><code class="language-csharp">
    public class MyMartenRegistry : MartenRegistry
    {
        public MyMartenRegistry()
        {
            // Opt into the Postgres 9.5 upsert style
            UpsertType = PostgresUpsertType.Standard;
            
            // I&#39;m going to search for user by UserName
            // pretty frequently, so I want that to be 
            // a duplicated, searchable field
            For&lt;User&gt;().Searchable(x =&gt; x.UserName);


            // Add a gin index to Company&#39;s json data storage
            For&lt;Company&gt;().GinIndexJsonData();
        }
    }
</code></pre>
<p>To apply your new <code>MartenRegistry</code>, just include it when you bootstrap the <code>IDocumentStore</code> as in this example:</p>
<pre><code class="language-csharp">
var store = DocumentStore.For(_ =&gt;
{
    _.Connection(&quot;your connection string&quot;);
    _.Schema.Include&lt;MyMartenRegistry&gt;();
});
</code></pre>
<p>Do note that you could happily use multiple <code>MartenRegistry</code> classes in larger applications if that is advantageous.</p>
<p>If you dislike using infrastructure attributes in your application code, you will probably prefer to use MartenRegistry.</p>
<h2>Searchable Fields</h2>
<p>According to our testing, the single best thing you can do to speed up queries against the JSONB documents
is to duplicate a property or field within the JSONB structure as a separate database column on the document
table. When you issue a Linq query using this duplicated property or field, Marten is able to write the SQL
query to run against the duplicated field instead of using JSONB operators. This of course only helps for
queries using the duplicated field.</p>
<p>To create a searchable field, you can use the <code>[Searchable]</code> attribute like this:</p>
<pre><code class="language-csharp">
    [PropertySearching(PropertySearching.ContainmentOperator)]
    public class Employee
    {
        public int Id;

        // You can optionally override the Postgresql
        // type for the duplicated column in the document
        // storage table
        [Searchable(PgType = &quot;text&quot;)]
        public string Category;
    }
</code></pre>
<p>By default, Marten adds a <a href="http://www.postgresql.org/docs/9.4/static/indexes-types.html">btree index</a> (the Postgresql default) to a searchable index, but you can also
customize the generated index with the syntax shown below:</p>
<pre><code class="language-csharp">
    public class IndexExamples : MartenRegistry
    {
        public IndexExamples()
        {
            // Add a gin index to the User document type
            For&lt;User&gt;().GinIndexJsonData();

            // Adds a basic btree index to the duplicated
            // field for this property that also overrides
            // the Postgresql database type for the column
            For&lt;User&gt;().Searchable(x =&gt; x.FirstName, pgType: &quot;varchar(50)&quot;);

            // Customize the index on the duplicated field
            // for FirstName 
            For&lt;User&gt;().Searchable(x =&gt; x.FirstName, configure:idx =&gt;
            {
                idx.IndexName = &quot;idx_special&quot;;
                idx.Method = IndexMethod.hash;
            });

        }
    }
</code></pre>
<h2>Gin Indexes</h2>
<p>To optimize a wider range of adhoc queries against the document JSONB, you can apply a <a href="http://www.postgresql.org/docs/9.4/static/gin.html">Gin index</a> to
the JSON field in the database:</p>
<pre><code class="language-csharp">
    public class IndexExamples : MartenRegistry
    {
        public IndexExamples()
        {
            // Add a gin index to the User document type
            For&lt;User&gt;().GinIndexJsonData();

            // Adds a basic btree index to the duplicated
            // field for this property that also overrides
            // the Postgresql database type for the column
            For&lt;User&gt;().Searchable(x =&gt; x.FirstName, pgType: &quot;varchar(50)&quot;);

            // Customize the index on the duplicated field
            // for FirstName 
            For&lt;User&gt;().Searchable(x =&gt; x.FirstName, configure:idx =&gt;
            {
                idx.IndexName = &quot;idx_special&quot;;
                idx.Method = IndexMethod.hash;
            });

        }
    }
</code></pre>
<p><strong>Marten may be changed to make the Gin index on the data field be automatic in the future.</strong></p>
<h2>&quot;UpsertStyle&quot;</h2>
<p>Marten started with the assumption that we would target Postgresql 9.5 and its <a href="https://wiki.postgresql.org/wiki/What%27s_new_in_PostgreSQL_9.5">new &quot;upsert&quot; functionality</a>,
but we have since backed off to making the older Postgresql upsert style the default with an &quot;opt-in&quot; choice
to use the 9.5 syntax:</p>
<pre><code class="language-csharp">
    public class SettingUpsertStyle : MartenRegistry
    {
        public SettingUpsertStyle()
        {
            // To use the traditional upsert style for 9.4 and below:
            UpsertType = PostgresUpsertType.Legacy;

            // To opt into the new 9.5 capabilities
            UpsertType = PostgresUpsertType.Standard;
        }
    }
</code></pre>
<h2>Custom Attributes</h2>
<p>If there's some kind of customization you'd like to use attributes for that isn't already supported by Marten,
you're still in luck. If you write a subclass of the <code>MartenAttribute</code> shown below:</p>
<pre><code class="language-csharp">
    public abstract class MartenAttribute : Attribute
    {
        /// &lt;summary&gt;
        /// Customize Document storage at the document level
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;mapping&quot;&gt;&lt;/param&gt;
        public virtual void Modify(DocumentMapping mapping) { }

        /// &lt;summary&gt;
        /// Customize the Document storage for a single member
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;mapping&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;member&quot;&gt;&lt;/param&gt;
        public virtual void Modify(DocumentMapping mapping, MemberInfo member) { }
    }
</code></pre>
<p>And decorate either classes or individual field or properties on a document type, your custom attribute will be
picked up and used by Marten to configure the underlying <code>DocumentMapping</code> model for that document type. The
<code>MartenRegistry</code> is just a fluent interface over the top of this same <code>DocumentMapping</code> model.</p>
<p>As an example, an attribute to add a gin index to the JSONB storage for more efficient adhoc querying of a document
would look like this:</p>
<pre><code class="language-csharp">
    public class GinIndexedAttribute : MartenAttribute
    {
        public override void Modify(DocumentMapping mapping, MemberInfo member)
        {
            mapping.AddGinIndexToData();
        }
    }
</code></pre>


			      	</div>

			      	<hr />

			      	<nav>
				        <span>
				        	<strong>Previous: </strong><a href="/marten/documentation/documents/diagnostics">Diagnostics</a>

				        </span>
				        <span class="pull-right">

				        	<strong>Next: </strong><a href="/marten/documentation/documents/text_search">Full Text Searching</a>

				        </span>
			      	</nav>

		      </div><!--/right-->
		  	</div><!--/row-->
		</div><!--/container-->


    </body>


    <foot>
        <script type='text/javascript' src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
        <script type='text/javascript' src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

        <script type="text/javascript" src="/marten/content/embed.js"></script>
        <script type="text/javascript" src="/marten/content/prism.js"></script>
        <script type="text/javascript" src="/marten/content/sidebar.js"></script>
        <script type="text/javascript" src="/marten/content/affix.js"></script>

<script>
$('#search').keyup(function(e){
  if(e.keyCode == 13) {
    var search = $('#search').val();

    var url = 'https://www.google.com/#q=site:jasperfx.github.io ' + search;
    url = encodeURI(url);

    //alert(url);

    window.location.href = url;

    e.stopPropagation();
    if (e.cancelBubble!=null) e.cancelBubble = true;
    return false;
  }



}); 

</script>
    </foot>
</html>

