<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8"> 
        <meta charset="utf-8">
        <meta name="generator" content="Bootply" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<title>Marten - Database Schema Objects</title>
		<link href="/marten/content/bootstrap.min.css" rel="stylesheet" type="text/css" />
		<link href="/marten/content/prism.css" rel="stylesheet" type="text/css" />
		<link href="/marten/content/theme.css" rel="stylesheet" type="text/css" />
		<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" />
        

        <link rel="apple-touch-icon" href="/bootstrap/img/apple-touch-icon.png">
        <link rel="apple-touch-icon" sizes="72x72" href="/bootstrap/img/apple-touch-icon-72x72.png">
        <link rel="apple-touch-icon" sizes="114x114" href="/bootstrap/img/apple-touch-icon-114x114.png">


        <!-- CSS code from Bootply.com editor -->
        <link href="/marten/content/affix.css" rel="stylesheet" type="text/css" />
    </head>
    
    <!-- HTML code from Bootply.com editor -->
    
    <body  >

<a href="https://github.com/jasperfx/marten"><img style="z-index: 5000; position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/e7bbb0521b397edbd5fe43e7f760759336b5e05f/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677265656e5f3030373230302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"></a>
        
        <nav class="navbar navbar-default navbar-fixed-top" role="banner">
		  <div class="container">
		    <div class="navbar-header">
		      <a href="/marten" class="navbar-brand">Marten</a>
		    </div>
		    <nav class="collapse navbar-collapse" role="navigation">
		      <ul class="nav navbar-nav pull-right">
            <li>
              <a href="/marten/getting_started">Getting Started</a>
            </li>
		        <li>
		          <a href="/marten/documentation">Documentation</a>
		        </li>
		        <li>
<a href="https://gitter.im/jasperfx/marten?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge&amp;utm_content=badge"><img src="https://camo.githubusercontent.com/da2edb525cde1455a622c58c0effc3a90b9a181c/68747470733a2f2f6261646765732e6769747465722e696d2f4a6f696e253230436861742e737667" alt="Join the chat at https://gitter.im/jasperfx/marten" data-canonical-src="https://badges.gitter.im/Join%20Chat.svg" style="max-width:100%;"></a>
		        </li>
		      	<li><a href="/marten/documentation/events" title="Marten as Event Store">Previous</a></li>
		      	
		      </ul>
      <div class="navbar-form navbar-left" role="search">
        <div class="form-group">
          <input id="search" type="search" class="form-control" placeholder="Search">
        </div>
      </div>

		    </nav>

		  </div>
		</nav>

		  <div class="container">
		  	<nav class="navbar-inverse">
		  		<ol class="breadcrumb"><li><a href="/marten/">Marten</a></li><li><a href="/marten/documentation">Documentation</a></li><li class="active">Database Schema Objects</li></ol>
		  	</nav>
		  </div>

		<!--main-->
		<div class="container">
			<div class="row">
		      <!--left-->
		      
		      <div class="col-md-3" id="leftCol">
		      	<h3>Marten 0.6.0</h3>
		      	<br />

				<ul class="nav nav-stacked affix" id="sidebar">

		        </ul>

		        	
		        	<h3 class="no-margin">Previous</h3><a href="/marten/documentation/events">Marten as Event Store</a></p>

		        </ul>
		      </div><!--/left-->
		      
		      <!--right-->
		      <div class="col-md-9">
			      	<h1>Database Schema Objects <a href="https://github.com/jasperfx/marten/blob/master/documentation/documentation/schema.md"  class="text-muted small pull-right fa fa-github" style="margin-top: 10px"> Edit on GitHub</a></h1>
			      
			      	<hr />

			      	<div id="main-pane">
			      		<!--Title:Database Schema Objects-->
<!--Url:schema-->
<p>Marten works by adding tables and functions (yes, Virginia, we've let stored procedures creep back into our life) to a Postgresql schema. In the default &quot;development&quot; mode, Marten will generate and add a table and matching &quot;upsert&quot; function for each unique document type as needed. In production, you
may either not have rights to generate new tables at runtime or simply not wish to do that. In that case, Marten exposes some ability to dump all
the SQL for creating these objects for <em>all the known document types</em> from <code>IDocumentStore</code> like this:</p>
<pre><code class="language-csharp">
        public void export_ddl()
        {
            var store = DocumentStore.For(_ =&gt;
            {
                _.Connection(&quot;some connection string&quot;);

                // include any MartenRegistry&#39;s you are using
                _.Schema.Include&lt;MyMartenRegistry&gt;();

                // If you are depending upon attributes for customization,
                // you have to help DocumentStore &quot;know&quot; what the document types
                // are
                _.Schema.For&lt;User&gt;();
                _.Schema.For&lt;Company&gt;();
                _.Schema.For&lt;Issue&gt;();
            });

            // Export the SQL to a file
            store.Schema.WriteDDL(&quot;my_database.sql&quot;);

            // or just see it
            var sql = store.Schema.ToDDL();
            Debug.WriteLine(sql);
        } 
</code></pre>
<p>For the moment, Marten is not directly supporting any kind of database migration strategy. To be honest, we're waiting to see how Marten plays out in production before investing in anything like that.</p>
<p>The code above creates the following SQL script below, with these elements:</p>
<ol>
<li>For each document type, there is a table systematically named <code>mt_doc_[document type name]</code> that consists of an id column and a
JSONB column called &quot;data&quot;</li>
<li>For each document type, there is a function called <code>mt_upsert_[document type name]</code> that performs inserts or updates of that document type</li>
<li>You'll see an index named <code>mt_doc_user_idx_user_name</code> that is on a duplicated, searchable field for the <code>User</code> document (it's configured by attribute)</li>
<li><code>mt_hilo</code> and <code>mt_get_next_hi</code> that support Marten's HiLo numeric identifier strategy.</li>
</ol>
<p>The full DDL exported from above is:</p>
<pre>
<p>DROP TABLE IF EXISTS mt_doc_user CASCADE;
CREATE TABLE mt_doc_user (
id           uuid CONSTRAINT pk_mt_doc_user PRIMARY KEY,
data         jsonb NOT NULL ,
user_name    varchar
);</p>
<p>CREATE OR REPLACE FUNCTION mt_upsert_user(docId uuid, doc JSONB, arg_user_name varchar) RETURNS VOID AS
$$
BEGIN
INSERT INTO mt_doc_user VALUES (docId, doc, arg_user_name)
ON CONFLICT ON CONSTRAINT pk_mt_doc_user
DO UPDATE SET data = doc, user_name = arg_user_name;
END;
$$ LANGUAGE plpgsql;</p>
<p>CREATE INDEX mt_doc_user_idx_user_name ON mt_doc_user (user_name)</p>
<p>DROP TABLE IF EXISTS mt_doc_company CASCADE;
CREATE TABLE mt_doc_company (
id      uuid CONSTRAINT pk_mt_doc_company PRIMARY KEY,
data    jsonb NOT NULL
);</p>
<p>CREATE OR REPLACE FUNCTION mt_upsert_company(docId uuid, doc JSONB) RETURNS VOID AS
$$
BEGIN
INSERT INTO mt_doc_company VALUES (docId, doc)
ON CONFLICT ON CONSTRAINT pk_mt_doc_company
DO UPDATE SET data = doc;
END;
$$ LANGUAGE plpgsql;</p>
<p>CREATE INDEX mt_doc_company_idx_data ON mt_doc_company USING gin (data jsonb_path_ops)</p>
<p>DROP TABLE IF EXISTS mt_doc_issue CASCADE;
CREATE TABLE mt_doc_issue (
id      uuid CONSTRAINT pk_mt_doc_issue PRIMARY KEY,
data    jsonb NOT NULL
);</p>
<p>CREATE OR REPLACE FUNCTION mt_upsert_issue(docId uuid, doc JSONB) RETURNS VOID AS
$$
BEGIN
INSERT INTO mt_doc_issue VALUES (docId, doc)
ON CONFLICT ON CONSTRAINT pk_mt_doc_issue
DO UPDATE SET data = doc;
END;
$$ LANGUAGE plpgsql;</p>
<p>DROP TABLE IF EXISTS mt_hilo CASCADE;
CREATE TABLE mt_hilo (
entity_name         varchar CONSTRAINT pk_mt_hilo PRIMARY KEY,
hi_value            bigint default 0
);</p>
<p>CREATE OR REPLACE FUNCTION mt_get_next_hi(entity varchar) RETURNS int AS $$
DECLARE
current_value bigint;
next_value bigint;
BEGIN
select hi_value into current_value from mt_hilo where entity_name = entity;
IF current_value is null THEN
insert into mt_hilo (entity_name, hi_value) values (entity, 0);
next_value := 0;
ELSE
next_value := current_value + 1;
update mt_hilo set hi_value = next_value where entity_name = entity;
END IF;</p>
<pre><code>return next_value;
</code></pre>
<p>END
$$ LANGUAGE plpgsql;</p>
</pre>
<p>TODO(make the sql formatting cleaner here!)</p>


			      	</div>

			      	<hr />

			      	<nav>
				        <span>
				        	<strong>Previous: </strong><a href="/marten/documentation/events">Marten as Event Store</a>

				        </span>
				        <span class="pull-right">

				        	

				        </span>
			      	</nav>

		      </div><!--/right-->
		  	</div><!--/row-->
		</div><!--/container-->


    </body>


    <foot>
        <script type='text/javascript' src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
        <script type='text/javascript' src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

        <script type="text/javascript" src="/marten/content/embed.js"></script>
        <script type="text/javascript" src="/marten/content/prism.js"></script>
        <script type="text/javascript" src="/marten/content/sidebar.js"></script>
        <script type="text/javascript" src="/marten/content/affix.js"></script>

<script>
$('#search').keyup(function(e){
  if(e.keyCode == 13) {
    var search = $('#search').val();

    var url = 'https://www.google.com/#q=site:jasperfx.github.io ' + search;
    url = encodeURI(url);

    //alert(url);

    window.location.href = url;

    e.stopPropagation();
    if (e.cancelBubble!=null) e.cancelBubble = true;
    return false;
  }



}); 

</script>
    </foot>
</html>

